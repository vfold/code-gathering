function readableFileSize(a){var b=["B","KB","MB","GB","TB","PB","EB","ZB","YB"],c=0;while(a>=1024)a/=1024,++c;return a.toFixed(1)+" "+b[c]}function AsyncLoop(a,b){var c=a,d=b,e,f=0;this.start=function(a){f=-1,e=a,this.next()},this.next=function(){f++,f<c.length?e(c[f]):d()}}function uploadDir(a){}function uploadFile(a){conn.put(fs.createReadStream(a),a,function(b,c){if(b)throw b;c.on("success",function(){console.log("Uploaded: "+a)})})}function Dir(a){this.path=a,this.files=[],this.dirs=[]}function DirTree(a,b){function c(a,b){var d=new AsyncLoop(a,function(){b()});d.start(function(a){listDir(a,function(a){new c(a.dirs,function(){d.next()})})})}resetListStats(),DirTree.prototype=new Dir(a),listDir(DirTree.prototype,function(a){new c(a.dirs,function(){console.log("Read "+totalFiles+" files of total size: "+readableFileSize(totalFileSize)),b(a)})})}function canCall(){return done?(done=!1,!0):(console.log("Cannot call.. FTP connection is in use"),!1)}function resetListStats(){totalFileSize=0,totalFiles=0}function listDir(a,b){if(!canCall)return;conn.cwd(a.path,function(c){if(c)throw c;conn.list(function(c,d){function f(){e++,e==2&&(b(a),done=!0)}if(c)throw c;var e=0;d.on("entry",function(b){if(b.type==="l")b.type="LINK";else if(b.type===TYPE_FILE)a.addFile(b),totalFileSize+=parseInt(b.size,10),totalFiles++;else if(b.type===TYPE_DIR){if(b.name=="."||b.name=="..")return;a.addDir(new Dir(a.path+"/"+b.name))}}),d.on("raw",function(a){}),d.on("error",function(a){console.log("ERROR during list(): "+util.inspect(a)),conn.end()}),d.on("end",f),d.on("success",f)})})}function formatDate(a){return(a.year<10?"0":"")+a.year+"-"+(a.month<10?"0":"")+a.month+"-"+(a.date<10?"0":"")+a.date}function downloadDir(a){function b(a,b){currLocalPath=a.substr(a.indexOf(dirRemoteTarget)+dirRemoteTarget.length+1);try{fs.lstatSync(currLocalPath),b()}catch(c){fs.mkdir(currLocalPath,755,b)}}function c(a,c,d){function e(a,c){var d=new AsyncLoop(a,function(){c()});d.start(function(a){b(a.path,function(){f(a.files,function(){new e(a.dirs,d.next)})})})}function f(a,b){var c=new AsyncLoop(a,function(){b()});c.start(function(a){var c=currLocalPath.length>1?currLocalPath+"/":"";c+=a.name;try{fs.lstatSync(c),b()}catch(d){downloadFile(c,dirRemoteTarget+"/"+c,syncLoop.next)}})}new e([a],d)}a&&console.log("<Pulling data from server and overwriting>"),new DirTree(dirRemoteTarget,function(a){c(a,function(){console.log("<Done!>"),conn.end()})})}function downloadFile(a,b,c){conn.get(b,function(b,d){if(b)throw b;d.on("success",function(){console.log("wrote "+file.name),c()}),d.on("error",function(a){console.log("ERROR during get(): "+util.inspect(a)),c()}),d.pipe(fs.createWriteStream(a))})}Dir.prototype={addFile:function(a){this.files.push(a)},addDir:function(a){this.dirs.push(a)},setPath:function(a){this.path=a}};var done=!0,FTPClient=require("ftp"),util=require("util"),fs=require("fs"),conn,action=process.ARGV[2],host=process.ARGV[3],port=process.ARGV[4],user=process.ARGV[5],pass=process.ARGV[6],dirLocalTarget=process.ARGV[7],dirRemoteTarget=process.ARGV[8],currLocalPath=dirLocalTarget,TYPE_FILE="-",TYPE_DIR="d",totalFileSize,totalFiles;conn=new FTPClient,conn.connect(port,host),conn.on("connect",function(){conn.auth(user,pass,function(a){if(a)throw a;switch(action){case"download-overwrite":downloadDir(!0);break;case"download-keep":downloadDir(!1);break;case"upload-overwrite":uploadDir(!0);break;case"upload-keep":uploadDir(!1)}})}),undefined